<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cuestionario DSS</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
      background-color: #f5f5f5;
    }

    .quiz-container {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }

    #question-counter {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 16px;
    }

    #question-text {
      font-size: 1.1rem;
      margin-bottom: 16px;
    }

    .options {
      list-style: none;
      padding: 0;
      margin: 0 0 16px 0;
    }

    .options li {
      margin-bottom: 8px;
    }

    .options label {
      cursor: pointer;
    }

    .buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      border: none;
      border-radius: 4px;
      padding: 8px 14px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    #btn-check {
      background-color: #1976d2;
      color: #ffffff;
    }

    #btn-next {
      background-color: #555555;
      color: #ffffff;
    }

    #btn-restart {
      background-color: #388e3c;
      color: #ffffff;
      margin-top: 10px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    #feedback {
      margin-top: 12px;
      font-weight: 600;
    }

    #feedback.correct {
      color: #2e7d32;
    }

    #feedback.incorrect {
      color: #c62828;
    }

    #final-score {
      margin-top: 16px;
      font-weight: 600;
    }

    .answer-explanation {
      font-size: 0.9rem;
      color: #444;
      margin-top: 4px;
    }

    .question-type {
      font-size: 0.85rem;
      color: #777;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="quiz-container">
    <h1>Cuestionario DSS</h1>
    <div id="question-counter"></div>
    <div id="question-type" class="question-type"></div>
    <div id="question-text"></div>
    <ul id="options" class="options"></ul>

    <div class="buttons">
      <button id="btn-check">Corregir</button>
      <button id="btn-next" disabled>Siguiente</button>
    </div>

    <div id="feedback"></div>
    <div id="final-score"></div>
    <button id="btn-restart" style="display:none;">Reiniciar cuestionario</button>
  </div>

  <!-- Huevo de pascua: overlay oculto -->
  <div id="easter-egg" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999;"> 
    <div style="background:#fff;padding:20px 24px;border-radius:8px;max-width:480px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.3);">
      <h2 style="margin:0 0 8px;font-size:1.1rem;">Huevo de pascua</h2>
      <p style="margin:0 0 12px;">Generado por: <strong>Ricardo, Gepeto y su Copiloto (2025-12-02)</strong></p>
      <button id="egg-close" style="background:#1976d2;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;">Cerrar</button>
    </div>
  </div>

  <script>
    // Banco de preguntas (externo)
    // Se cargan desde un archivo JSON en la misma carpeta. Por defecto usa `preguntas.json`.
    // Para apuntar a otro archivo: abrir `prueba01.html?bank=otro.json`
    let questions = [];
    const defaultBankFile = 'preguntas.json';
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const bankFile = getQueryParam('bank') || defaultBankFile;

    // --- Lógica del cuestionario ---
    let currentIndex = 0;
    let score = 0;
    let answered = false;

    // Si querés que el orden sea aleatorio, descomentá esta función y el llamado a shuffle.
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // shuffle(questions);

    const questionCounterEl = document.getElementById("question-counter");
    const questionTypeEl = document.getElementById("question-type");
    const questionTextEl = document.getElementById("question-text");
    const optionsEl = document.getElementById("options");
    const feedbackEl = document.getElementById("feedback");
    const finalScoreEl = document.getElementById("final-score");
    const btnCheck = document.getElementById("btn-check");
    const btnNext = document.getElementById("btn-next");
    const btnRestart = document.getElementById("btn-restart");

    function renderQuestion() {
      // eliminar explicaciones previas que quedaron en el DOM
      document.querySelectorAll('.answer-explanation').forEach(el => el.remove());

      const q = questions[currentIndex];
      answered = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "";
      finalScoreEl.textContent = "";

      questionCounterEl.textContent = `Pregunta ${currentIndex + 1} de ${questions.length}`;
      questionTypeEl.textContent = q.type === "single"
        ? "Tipo: opción única"
        : "Tipo: opción múltiple";
      questionTextEl.textContent = q.text;

      optionsEl.innerHTML = "";
      const inputType = q.type === "single" ? "radio" : "checkbox";

      q.options.forEach((opt, idx) => {
        const li = document.createElement("li");
        const label = document.createElement("label");
        const input = document.createElement("input");

        input.type = inputType;
        input.name = "option";
        input.value = idx;

        label.appendChild(input);
        label.appendChild(document.createTextNode(" " + opt));
        li.appendChild(label);
        optionsEl.appendChild(li);
      });

      btnCheck.disabled = false;
      btnNext.disabled = true;
    }

    function getSelectedIndices() {
      const inputs = optionsEl.querySelectorAll("input");
      const selected = [];
      inputs.forEach((input, idx) => {
        if (input.checked) {
          selected.push(idx);
        }
      });
      return selected;
    }

    function arraysEqual(a, b) {
      if (a.length !== b.length) return false;
      const aSorted = [...a].sort();
      const bSorted = [...b].sort();
      for (let i = 0; i < aSorted.length; i++) {
        if (aSorted[i] !== bSorted[i]) return false;
      }
      return true;
    }

    function checkAnswer() {
      if (answered) return;
      const q = questions[currentIndex];
      const selected = getSelectedIndices();

      if (selected.length === 0) {
        feedbackEl.textContent = "Seleccioná al menos una opción antes de corregir.";
        feedbackEl.className = "incorrect";
        return;
      }

      const isCorrect = arraysEqual(selected, q.correct);
      answered = true;

      if (isCorrect) {
        score++;
        feedbackEl.textContent = "Correcto.";
        feedbackEl.className = "correct";
      } else {
        feedbackEl.textContent = "Incorrecto.";
        feedbackEl.className = "incorrect";
      }

      // Mostrar la(s) respuesta(s) correcta(s)
      const correctTexts = q.correct.map(idx => q.options[idx]);
      const explanationText = q.explanation ? q.explanation : "";
      const explanationDiv = document.createElement("div");
      explanationDiv.className = "answer-explanation";
      explanationDiv.textContent =
        `Respuesta correcta: ${correctTexts.join(" | ")}`
        + (explanationText ? ` — ${explanationText}` : "");

      // Limpiar explicación anterior si la hubiera
      const oldExplanation = feedbackEl.nextElementSibling;
      if (oldExplanation && oldExplanation.classList.contains("answer-explanation")) {
        oldExplanation.remove();
      }
      feedbackEl.insertAdjacentElement("afterend", explanationDiv);

      btnCheck.disabled = true;
      btnNext.disabled = false;

      // Si es la última pregunta, preparar mensaje final
      if (currentIndex === questions.length - 1) {
        btnNext.textContent = "Finalizar";
      } else {
        btnNext.textContent = "Siguiente";
      }
    }

    function nextQuestion() {
      if (!answered) return;

      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        // Fin del cuestionario
        // eliminar explicaciones previas al mostrar resultado final
        document.querySelectorAll('.answer-explanation').forEach(el => el.remove());
        questionCounterEl.textContent = "Cuestionario finalizado";
        questionTypeEl.textContent = "";
        questionTextEl.textContent = "";
        optionsEl.innerHTML = "";
        feedbackEl.textContent = "";
        const porcentaje = ((score / questions.length) * 100).toFixed(1);
        finalScoreEl.textContent =
          `Puntaje final: ${score} / ${questions.length} (${porcentaje}%)`;
        btnCheck.disabled = true;
        btnNext.disabled = true;
        btnRestart.style.display = "inline-block";
      }
    }

    function restartQuiz() {
      currentIndex = 0;
      score = 0;
      answered = false;
      btnRestart.style.display = "none";
      renderQuestion();
    }

    btnCheck.addEventListener("click", checkAnswer);
    btnNext.addEventListener("click", nextQuestion);
    btnRestart.addEventListener("click", restartQuiz);

    // Cargar banco de preguntas y luego renderizar
    async function loadQuestions() {
      try {
        const res = await fetch(bankFile);
        if (!res.ok) throw new Error(`${bankFile} -> ${res.status} ${res.statusText}`);
        questions = await res.json();
        // Si querés preguntas aleatorias descomentá la siguiente línea:
        // shuffle(questions);
        renderQuestion();
      } catch (err) {
        questionCounterEl.textContent = '';
        questionTypeEl.textContent = '';

        function escapeHtml(str) {
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        }

        const msgLines = [];
        msgLines.push(`Error cargando banco de preguntas: ${escapeHtml(err.message)}, puede cargar otro archivo usando el parámetro URL \`?bank=archivo.json\`.`);

        // Detectar casos comunes donde fetch falla (archivo abierto con file:// o problema de red)
        if (location.protocol === 'file:' || /Failed to fetch|Load failed|NetworkError/i.test(err.message)) {
          msgLines.push('Nota: es probable que estés abriendo el archivo directamente (protocolo file://).');
          msgLines.push('El navegador bloquea llamadas `fetch` cuando se abre el HTML desde el sistema de archivos.');
          msgLines.push('Inicia un servidor HTTP local en la carpeta del cuestionario y abre la página vía http://localhost:8000:');
          msgLines.push('python3 -m http.server 8000');
          msgLines.push('o');
          msgLines.push('npx serve .');
        }

        // Construir HTML con saltos de línea y bloques `pre` para comandos
        questionTextEl.innerHTML = msgLines.map(line => {
          if (line === 'python3 -m http.server 8000' || line === 'npx serve .') {
            return `<pre style="display:inline-block;padding:6px;background:#f6f6f6;border-radius:4px;margin:4px 0;">${escapeHtml(line)}</pre>`;
          }
          return escapeHtml(line);
        }).join('<br>');

        optionsEl.innerHTML = '';
        btnCheck.disabled = true;
        btnNext.disabled = true;
      }
    }

    // Render inicial tras cargar el banco
    loadQuestions();

    // --- Huevo de pascua (triple-clic en el título o Ctrl+Shift+G) ---
    (function setupEasterEgg(){
      const egg = document.getElementById('easter-egg');
      const eggClose = document.getElementById('egg-close');
      const title = document.querySelector('.quiz-container h1');

      let clickCount = 0;
      let clickTimer = null;

      function showEgg(){
        egg.style.display = 'flex';
      }
      function hideEgg(){
        egg.style.display = 'none';
      }

      // triple click on title within 700ms
      title.addEventListener('click', () => {
        clickCount++;
        if (clickTimer) clearTimeout(clickTimer);
        clickTimer = setTimeout(() => { clickCount = 0; }, 700);
        if (clickCount >= 3) {
          clickCount = 0;
          showEgg();
        }
      });

      // keyboard shortcut Ctrl+Shift+G
      window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && (e.key === 'G' || e.key === 'g')) {
          showEgg();
        }
      });

      eggClose.addEventListener('click', hideEgg);
      egg.addEventListener('click', (ev) => {
        if (ev.target === egg) hideEgg();
      });
    })();
  </script>
</body>
</html>